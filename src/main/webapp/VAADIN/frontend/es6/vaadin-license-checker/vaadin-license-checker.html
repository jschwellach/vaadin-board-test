<html><head><link rel="import" href="../polymer/polymer.html"><link rel="import" href="../iron-localstorage/iron-localstorage.html"><link rel="import" href="../iron-ajax/iron-ajax.html"><link rel="import" href="vaadin-license-box.html"><link rel="import" href="vaadin-license-dialog.html"><link rel="import" href="vaadin-license-notification.html"><link rel="import" href="vaadin-framework-identifier.html"></head><body><dom-module id="vaadin-license-checker"><template><iron-localstorage id="storageLicense" name="[[storageKey]]" value="{{licenseKey}}" use-raw="true"></iron-localstorage><iron-localstorage id="storageLicenseCheckTime" name="[[storageKeyCheckTime]]" value="{{licenseCheckTime}}" use-raw="true"></iron-localstorage><iron-localstorage id="storageLicenseType" name="[[storageKeyType]]" value="{{licenseKeyType}}" use-raw="true"></iron-localstorage><iron-ajax id="licenseRequest" url="[[licenseUrl]]" headers="[[licenseRequestHeaders]]" handle-as="json" on-response="_handleResultFromServer" on-error="_handleErrorFromServer" debounce-duration="300"></iron-ajax></template><script>LicenseChecker=Polymer({is:"vaadin-license-checker",instances:{},licenseDialog:void 0,licenseBox:void 0,notification:void 0,frameworkIdentifier:void 0,licenseTypes:{VALID:"valid",UNLICENSED:"unlicensed",TRIAL:"trial",EXPIRED:"expired"},properties:{licenseKey:{type:String,notify:!0},licenseCheckTime:{type:Number},licenseKeyType:{type:String},licenseUrlBase:{type:String,value:"https://tools.vaadin.com/vaadin-license-server/licenses/"},licenseUrl:{type:String,computed:"_computeUrl(licenseUrlBase, licenseKey)"},productName:String,productVersion:Number,productCaption:String,storageKey:{type:String,computed:"_computeStorageKey(productName)"},storageKeyCheckTime:{type:String,computed:"_computeStorageKeyCheckTime(productName)"},storageKeyType:{type:String,computed:"_computeStorageKeyType(productName)"},_yesterday:{type:Number,value:function(){var a=new Date;return a.setDate(a.getDate()-1),a.getTime()},readOnly:!0},_manualSubmit:{type:Boolean,value:!1},licenseRequestHeaders:String},attached:function(){this._exists(this.instances[this.storageKey])||(this.instances[this.storageKey]=this,this._isLocalhost()&&(this.$.storageLicense.reload(),this._exists(this.licenseKey)?this._checkLicenseKey():(this.licenseCheckTime===void 0&&(this.licenseCheckTime=window.localStorage.getItem(this._computeStorageKeyCheckTime(this.productName))),null===this.licenseCheckTime||this.licenseCheckTime<=this._yesterday?this._showLicenseDialog(this.licenseTypes.UNLICENSED):this._showLicenseBox(this.licenseTypes.UNLICENSED))))},detached:function(){this._existsAndAttached(this.licenseBox)&&(this._removeFromParent(this.licenseBox),this.licenseBox=void 0),this._existsAndAttached(this.licenseDialog)&&(this._removeFromParent(this.licenseDialog),this.licenseDialog=void 0),this._existsAndAttached(this.notification)&&(this._removeFromParent(this.notification),this.notification=void 0),this._existsAndAttached(this.frameworkIdentifier)&&(this._removeFromParent(this.frameworkIdentifier),this.frameworkIdentifier=void 0),this.instances[this.storageKey]===this&&(this.instances[this.storageKey]=void 0)},_removeFromParent:function(a){a.parentNode.removeChild(a)},_existsAndAttached:function(a){return a&&a.parentNode!=void 0},_checkLicenseKey:function(a,b){0===arguments.length&&(a=this.licenseKey);var c=this._computeUrl(this.licenseUrlBase,a);this._identifyFramework(),this._setLicenseRequestHeaders(),this.$.licenseRequest.url=c,this._manualSubmit=!!b,this.$.licenseRequest.generateRequest()},_computeUrl:function(a,b){return a+b},_handleErrorFromServer:function(){this._manualSubmit||null==this.licenseCheckTime||this.licenseCheckTime<=this._yesterday?(this._showLicenseDialog(this.licenseTypes.UNLICENSED),this.licenseKeyType=this.licenseTypes.UNLICENSED,this.licenseCheckTime=new Date().getTime()):this.licenseKeyType!==this.licenseTypes.VALID&&this._showLicenseBox(this.licenseKeyType||this.licenseTypes.UNLICENSED),this._fireLoadReadyEvent()},_handleResultFromServer:function(a){var b=a.detail,c=b.response;200==b.status&&this._isValidLicense(c.product.name,c.product.version)?!0===c.expired?(this.licenseKey=c.licenseKey,this._showLicenseBox(this.licenseTypes.EXPIRED),this.licenseKeyType=this.licenseTypes.EXPIRED):"evaluation"===c.type?(this.licenseKey=c.licenseKey,this._showLicenseBox(this.licenseTypes.TRIAL,c.expiredEpoch),this.licenseKeyType=this.licenseTypes.TRIAL):(this.licenseKey!==c.licenseKey&&(this._showSuccessNotification(),this.licenseKey=c.licenseKey),this.licenseKeyType=this.licenseTypes.VALID):(this._showLicenseDialog(this.licenseTypes.UNLICENSED),this.licenseKeyType=this.licenseTypes.UNLICENSED),this.licenseCheckTime=new Date().getTime(),this._fireLoadReadyEvent()},_isLocalhost:function(){var a=window.location.hostname;return"localhost"===a||"127.0.0.1"===a},_isValidLicense:function(a,b){return a===this.productName&&(b==this.productVersion||!this._exists(b))},_fireLoadReadyEvent:function(){this.fire("license-check-done")},_exists:function(a){return null!==a&&a!==void 0&&""!==a},_computeStorageKey:function(a){return"vaadin."+a+".developer.license.key"},_computeStorageKeyCheckTime:function(a){return"vaadin."+a+".license.check.time"},_computeStorageKeyType:function(a){return"vaadin."+a+".license.key.type"},_licenseDialogClosed:function(a){this._showLicenseBox(a.detail.type,a.detail.expiryEpoch),this.licenseCheckTime=new Date().getTime(),this._hideLicenseDialog()},_licenseBoxClosed:function(a){this._showLicenseDialog(a.detail.type,a.detail.expiryEpoch),this._hideLicenseBox()},_licenseBoxSubmit:function(a){this._checkLicenseKey(a.detail.licenseKey,!0),this.licenseCheckTime=new Date().getTime(),this._hideLicenseDialog()},_showLicenseDialog:function(a,b){this.licenseDialog||(this.licenseDialog=document.createElement("vaadin-license-dialog")),Polymer.dom(document.body).appendChild(this.licenseDialog),this.hideLicenseDialogReference=this._licenseDialogClosed.bind(this),this.hideLicenseBoxSubmitReference=this._licenseBoxSubmit.bind(this),this.licenseDialog.addEventListener("vaadin-license-dialog-close",this.hideLicenseDialogReference),this.licenseDialog.addEventListener("vaadin-license-dialog-submit",this.hideLicenseBoxSubmitReference),this.licenseDialog.type=a,this.licenseDialog.productCaption=this.productCaption,a===this.licenseTypes.TRIAL&&(this.licenseDialog.expiryEpoch=b)},_hideLicenseDialog:function(){this.licenseDialog.removeEventListener("vaadin-license-dialog-close",this.hideLicenseDialogReference),this.licenseDialog.removeEventListener("vaadin-license-dialog-submit",this.hideLicenseBoxSubmitReference),Polymer.dom(document.body).removeChild(this.licenseDialog)},_showLicenseBox:function(a,b){this.licenseBox||(this.licenseBox=new LicenseBox),Polymer.dom(document.body).appendChild(this.licenseBox),this.hideLicenseBoxReference=this._licenseBoxClosed.bind(this),this.licenseBox.addEventListener("vaadin-license-box-close",this.hideLicenseBoxReference),this.licenseBox.type=a,this.licenseBox.productCaption=this.productCaption,a===this.licenseTypes.TRIAL&&(this.licenseBox.expiryEpoch=b)},_hideLicenseBox:function(){this.licenseBox.removeEventListener("vaadin-license-box-close",this.hideLicenseBoxReference),Polymer.dom(document.body).removeChild(this.licenseBox)},_showSuccessNotification:function(){this.notification||(this.notification=new LicenseNotification),Polymer.dom(this.root).appendChild(this.notification),this.hideSuccessReference=this._hideSuccessNotification.bind(this),this.notification.addEventListener("click",this.hideSuccessReference)},_hideSuccessNotification:function(){this.notification.removeEventListener("click",this.hideSuccessReference),Polymer.dom(this.root).removeChild(this.notification)},_identifyFramework:function(){this.frameworkIdentifier||(this.frameworkIdentifier=new FrameworkIdentifier,Polymer.dom(this).appendChild(this.frameworkIdentifier)),this.frameworkIdentifier.setFrameWorkAndVersion()},_setLicenseRequestHeaders:function(){this.licenseRequestHeaders={"check-source":"webcomponent",framework:this.frameworkIdentifier.framework,version:this.frameworkIdentifier.version,"product-name":this.productName,"product-version":this.productVersion}}});</script></dom-module></body></html>